<!DOCTYPE html>
<html lang="en">
    {% include "head.html" %}
<body>
    <style>
        p span {
    display: block;
    width: 100%;
    word-wrap:break-word;
    white-space: normal;
        }
    </style>
    <script>
        async function getNewPublicKey() {
            localStorage.removeItem('public_key_n');
            localStorage.removeItem('public_key_e');
            fetch('/put/change_key', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "reason": "Staring"
                })
            }).then(response => {
                if (response.status === 200) {
                    alert('Public key reseted');
                } else {
                    alert('Something went wrong');
                }
            });
            fetch('/get/public_key'
            ).then(response => {
                response.json().then(data => {
                    localStorage.setItem('public_key_n', data.public_key.n);
                    localStorage.setItem('public_key_e', data.public_key.e);
                    document.getElementById('public_key_n').innerText = data.public_key.n;
                    document.getElementById('public_key_e').innerText = data.public_key.e;
                });
            });
        }

        function sendSecret(secret) {
            if (!localStorage.getItem('public_key_n') || !localStorage.getItem('public_key_e')) {
                getNewPublicKey().then(() => {
                    sendSecret(secret);
                });
                return;
            } else {
                let public_key_n = localStorage.getItem('public_key_n');
                let public_key_e = localStorage.getItem('public_key_e');
                let secret_bytes = new TextEncoder().encode(secret);
                let secret_number = BigInt('0x' + secret_bytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), ''));
                let encrypted_secret = secret_number ** BigInt(public_key_e) % BigInt(public_key_n);
                let encrypted_secret_string = encrypted_secret.toString(16);
                fetch('/send_secret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secret: encrypted_secret_string
                    })
                }).then(response => {
                    if (response.status === 200) {
                        response.json().then(data => {
                            alert('Thanks for sharing me your secret, I will never tell it to anyone!');
                        });
                    } else {
                        alert('Something went wrong');
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('public_key_n').innerText = "waiting...";
            document.getElementById('public_key_e').innerText = "waiting...";
            getNewPublicKey();
        }, false);
    </script>
    {% include "header.html" %}
<textarea id="secret" name="secret" rows="1" cols="100"></textarea>
<div>
    <p>Public key:</p>
    <p>N: <span id="public_key_n"></span></p>
    <p>E: <span id="public_key_e"></span></p>
</div>
<div>
    
<input type="submit" value="Send secret" onclick="sendSecret(document.getElementById('secret').value)">
</div>

{% include "footer.html" %}
</body>
</html>
